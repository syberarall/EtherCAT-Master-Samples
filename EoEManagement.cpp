//********************************************************************************
//
//	This code is strictly reserved by SYBERA. It´s used only for
//	demonstration purposes. Any modification or integration
//	isn´t allowed without permission by SYBERA.
//
//  Copyright (c) 2021 SYBERA
//
//********************************************************************************
#include <windows.h>
#include "Sha64EcatCore.h"
#include "Ecat64CoreDef.h"
#include "Ecat64EoeDef.h"

#pragma comment(lib, "Powrprof.lib")


#pragma warning(disable:4996)
#pragma warning(disable:4748)

#define EOE_MAC_ADDRESS		(PUCHAR)"\x02\x01\x05\x10\x03\xEA"
#define EOE_PORT            80
#define EOE_DNS_NAME		(PUCHAR)"ECATSEN_1_Seri                  "
							//12345678901234567890123456789012
#define HOST_PORT			0xD000

//Declare some globals
PUCHAR    __pHostMac         = OVERRIDE_ADDRESS;
UCHAR     __HostIP[4]        = { 192, 168, 1, 5 };
USHORT    __HostPort         = HOST_PORT;
PUCHAR    __pEoeMacAddress   = EOE_MAC_ADDRESS;
UCHAR     __EoeIpAddr[4]     = { 192, 168, 1, 34 };
USHORT    __EoePort          = EOE_PORT;
UCHAR     __EoeSubnetMask[4] = { 255, 255, 255, 0 };
UCHAR     __EoeGateway[4]    = { 182, 168, 1, 10 };
UCHAR     __EoeDnsIpAddr[4]  = { 0, 0, 0, 0 };
PUCHAR    __pEoeDnsName      = EOE_DNS_NAME;

UCHAR     __RxTcpData[MAX_EOE_DATA_SIZE] = { 0 };
USHORT    __RxTcpDataLen = 0;
ULONG     __RxTcpCnt = 0;

//Get externals
extern PSTATION_INFO __pUserList;


UCHAR __TcpData4[] =  { 0x47, 0x45, 0x54, 0x20, 0x2f, 0x6e, 0x65, 0x74, 0x78, 0x2f,
						0x64, 0x69, 0x61, 0x67, 0x20, 0x48, 0x54, 0x54, 0x50, 0x2f, 0x31, 0x2e, 0x31, 0x0d, 0x0a, 0x48,
						0x6f, 0x73, 0x74, 0x3a, 0x20, 0x31, 0x39, 0x32, 0x2e, 0x31, 0x36, 0x38, 0x2e, 0x31, 0x2e, 0x33,
                                                                                              
						0x34, 0x0d, 0x0a, 0x55, 0x73, 0x65, 0x72, 0x2d, 0x41, 0x67, 0x65, 0x6e, 0x74, 0x3a, 0x20, 0x4d,
						0x6f, 0x7a, 0x69, 0x6c, 0x6c, 0x61, 0x2f, 0x35, 0x2e, 0x30, 0x20, 0x28, 0x57, 0x69, 0x6e, 0x64,
						0x6f, 0x77, 0x73, 0x20, 0x4e, 0x54, 0x20, 0x31, 0x30, 0x2e, 0x30, 0x3b, 0x20, 0x57, 0x69, 0x6e,
						0x36, 0x34, 0x3b, 0x20, 0x78, 0x36, 0x34, 0x3b, 0x20, 0x72, 0x76, 0x3a, 0x39, 0x33, 0x2e, 0x30,
						0x29, 0x20, 0x47, 0x65, 0x63, 0x6b, 0x6f, 0x2f, 0x32, 0x30, 0x31, 0x30, 0x30, 0x31, 0x30, 0x31,
						0x20, 0x46, 0x69, 0x72, 0x65, 0x66, 0x6f, 0x78, 0x2f, 0x39, 0x33, 0x2e, 0x30, 0x0d, 0x0a, 0x41,
                                                                                              
						0x63, 0x63, 0x65, 0x70, 0x74, 0x3a, 0x20, 0x74, 0x65, 0x78, 0x74, 0x2f, 0x68, 0x74, 0x6d, 0x6c,
						0x2c, 0x61, 0x70, 0x70, 0x6c, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x2f, 0x78, 0x68, 0x74,
						0x6d, 0x6c, 0x2b, 0x78, 0x6d, 0x6c, 0x2c, 0x61, 0x70, 0x70, 0x6c, 0x69, 0x63, 0x61, 0x74, 0x69,
						0x6f, 0x6e, 0x2f, 0x78, 0x6d, 0x6c, 0x3b, 0x71, 0x3d, 0x30, 0x2e, 0x39, 0x2c, 0x69, 0x6d, 0x61,
						0x67, 0x65, 0x2f, 0x61, 0x76, 0x69, 0x66, 0x2c, 0x69, 0x6d, 0x61, 0x67, 0x65, 0x2f, 0x77, 0x65,
						0x62, 0x70, 0x2c, 0x2a, 0x2f, 0x2a, 0x3b, 0x71, 0x3d, 0x30, 0x2e, 0x38, 0x0d, 0x0a, 0x41, 0x63,
                                                                                              
						0x63, 0x65, 0x70, 0x74, 0x2d, 0x4c, 0x61, 0x6e, 0x67, 0x75, 0x61, 0x67, 0x65, 0x3a, 0x20, 0x64,
						0x65, 0x2c, 0x65, 0x6e, 0x2d, 0x55, 0x53, 0x3b, 0x71, 0x3d, 0x30, 0x2e, 0x37, 0x2c, 0x65, 0x6e,
						0x3b, 0x71, 0x3d, 0x30, 0x2e, 0x33, 0x0d, 0x0a, 0x41, 0x63, 0x63, 0x65, 0x70, 0x74, 0x2d, 0x45,
						0x6e, 0x63, 0x6f, 0x64, 0x69, 0x6e, 0x67, 0x3a, 0x20, 0x67, 0x7a, 0x69, 0x70, 0x2c, 0x20, 0x64,
						0x65, 0x66, 0x6c, 0x61, 0x74, 0x65, 0x0d, 0x0a, 0x43, 0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74, 0x69,
						0x6f, 0x6e, 0x3a, 0x20, 0x6b, 0x65, 0x65, 0x70, 0x2d, 0x61, 0x6c, 0x69, 0x76, 0x65, 0x0d, 0x0a,
                                                                                              
						0x55, 0x70, 0x67, 0x72, 0x61, 0x64, 0x65, 0x2d, 0x49, 0x6e, 0x73, 0x65, 0x63, 0x75, 0x72, 0x65,
						0x2d, 0x52, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x73, 0x3a, 0x20, 0x31, 0x0d, 0x0a, 0x43, 0x61,
						0x63, 0x68, 0x65, 0x2d, 0x43, 0x6f, 0x6e, 0x74, 0x72, 0x6f, 0x6c, 0x3a, 0x20, 0x6d, 0x61, 0x78,
						0x2d, 0x61, 0x67, 0x65, 0x3d, 0x30, 0x0d, 0x0a, 0x0d, 0x0a };


UCHAR __TcpData5[] =  "http://192.168.1.34/webif/getval?ADR=200BF3EC&DT=5&CNT=8";


BOOLEAN EoeEnter(PSTATION_INFO pStation)
{
	//Init EOE management
	Ecat64EoeInit(
			&__pUserList[0],
			__pHostMac,
			__HostIP,
			__HostPort,
			__pEoeMacAddress,
			__EoeIpAddr,
			__EoeSubnetMask,
			__EoeGateway,
			__EoeDnsIpAddr,
			(PUCHAR)EOE_DNS_NAME);
	
	Sleep(100);

	//TCP Connect
	Ecat64EoeTcpConnect(
					&__pUserList[0],
					__pEoeMacAddress,
					__EoeIpAddr,
					__EoePort);
	
	Sleep(100);

	//TCP send data
	Ecat64EoeTcpSend(
				&__pUserList[0],
				(PUCHAR)__TcpData4,
				(USHORT)sizeof(__TcpData4));

	//Tcp receive data
	Ecat64EoeTcpReceive(
					&__pUserList[0],
					__RxTcpData,
					&__RxTcpDataLen);

	Sleep(100);

	//Close EOE TCP
	Ecat64EoeTcpClose(&__pUserList[0]);
	return TRUE;
}


VOID EoeExit(VOID)
{
	//Exit EOE management
	Ecat64EoeExit();
}





